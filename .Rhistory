sm$Habitat <- "Seamount"
out <-rbind(ma, sc, sm)
}
mask_habitat(cmip6_2041_2060_exsd)
mask_habitat <- function(x){
pred <- addLayer(etopo2022, x %>% subset(1:4))
# Mask continental margin
ma <- pred %>% mask(eez) %>% as.data.frame(xy = TRUE) %>% na.omit
ma$Habitat <- cut(-ma$layer, c(0, 200, 5000), labels=c("Shelf", "Slope"))
# Mask submarine canyons
sc <- pred %>% mask(canyon) %>% mask(eez) %>% as.data.frame(xy = TRUE) %>% na.omit
sc$Habitat <- "Canyon"
# Mask seamounts
sm <- pred %>% mask(seamount) %>% mask(eez) %>% as.data.frame(xy = TRUE) %>% na.omit
sm$Habitat <- "Seamount"
rbind(ma, sc, sm)
}
mask_habitat(cmip6_2041_2060_exsd)
mask_habitat <- function(x){
pred <- addLayer(etopo2022, x %>% subset(1:4))
# Mask continental margin
ma <- pred %>% mask(eez) %>% as.data.frame(xy = TRUE) %>% na.omit
ma$Habitat <- cut(-ma$layer, c(0, 200, 5000), labels=c("Shelf", "Slope"))
# Mask submarine canyons
sc <- pred %>% mask(canyon) %>% mask(eez) %>% as.data.frame(xy = TRUE) %>% na.omit
sc$Habitat <- "Canyon"
# Mask seamounts
sm <- pred %>% mask(seamount) %>% mask(eez) %>% as.data.frame(xy = TRUE) %>% na.omit
sm$Habitat <- "Seamount"
# Combine and stack data frame
rbind(ma, sc, sm) %>% gather(-x, -y, -layer, -Habitat, key = "var", value = "value")
}
out <- mask_habitat(cmip6_2041_2060_exsd)
out
ggplot(data=mask_habitat(cmip6_2041_2060_exsd))+
geom_violin(aes(x=Habitat, y=value))+
facet_wrap(~var, scales="free", nrow=1)+
labs(y="Climate Change Hazards")
plot_fun(cmip6_extoe_early %>% subset(1:4) %>% mask(eez), colours = brewer.pal(10, 'RdYlBu'), q_limits = c(0, 1))
ggplot(data=mask_habitat(cmip6_extoe_early))+
geom_violin(aes(x=Habitat, y=value))+
facet_wrap(~var, scales="free", nrow=1)+
labs(y="Time of Emergence of Climate Change")
ggplot(data=mask_habitat(cmip6_2041_2060_exsd))+
geom_violin(aes(x=Habitat, y=value))+
facet_wrap(~var, scales="free", nrow=1)+
labs(y="Climate Change Hazards")
mask_habitat(overlay(subset(cmip6_extoe_early, 1:4))
)
overlay(subset(cmip6_extoe_early, 1:4)
)
mask_habitat(overlay(subset(cmip6_extoe_early, 1:4), fun=max))
overlay(subset(cmip6_extoe_early, 1:4), fun=max)
# Custom function to mask habitats
mask_habitat <- function(x){
pred <- addLayer(etopo2022, x)
# Mask continental margin
ma <- pred %>% mask(eez) %>% as.data.frame(xy = TRUE) %>% na.omit
ma$Habitat <- cut(-ma$layer, c(0, 200, 5000), labels=c("Shelf", "Slope"))
# Mask submarine canyons
sc <- pred %>% mask(canyon) %>% mask(eez) %>% as.data.frame(xy = TRUE) %>% na.omit
sc$Habitat <- "Canyon"
# Mask seamounts
sm <- pred %>% mask(seamount) %>% mask(eez) %>% as.data.frame(xy = TRUE) %>% na.omit
sm$Habitat <- "Seamount"
# Combine and stack data frame
rbind(ma, sc, sm) %>% gather(-x, -y, -layer, -Habitat, key = "var", value = "value")
}
ggplot(data=mask_habitat(cmip6_2041_2060_exsd %>% subset(1:4)))+
geom_violin(aes(x=Habitat, y=value))+
facet_wrap(~var, scales="free", nrow=1)+
labs(y="Climate Change Hazards")
ggplot(data=mask_habitat(cmip6_extoe_early %>% subset(1:4)))+
geom_violin(aes(x=Habitat, y=value))+
facet_wrap(~var, scales="free", nrow=1)+
labs(y="Time of Emergence of Climate Change")
mask_habitat(overlay(subset(cmip6_extoe_early, 1:4), fun=max))
x=overlay(subset(cmip6_extoe_early, 1:4), fun=max)
x
pred <- addLayer(etopo2022, x)
pred
# Mask continental margin
ma <- pred %>% mask(eez) %>% as.data.frame(xy = TRUE) %>% na.omit
head(ma)
ma$Habitat <- cut(-ma[,3], c(0, 200, 5000), labels=c("Shelf", "Slope"))
# Mask submarine canyons
sc <- pred %>% mask(canyon) %>% mask(eez) %>% as.data.frame(xy = TRUE) %>% na.omit
# Mask submarine canyons
sc <- pred %>% mask(canyon) %>% mask(eez) %>% as.data.frame(xy = TRUE) %>% na.omit
sc$Habitat <- "Canyon"
# Mask seamounts
sm <- pred %>% mask(seamount) %>% mask(eez) %>% as.data.frame(xy = TRUE) %>% na.omit
sm$Habitat <- "Seamount"
# Combine and stack data frame
rbind(ma, sc, sm) %>% gather(-x, -y, -layer, -Habitat, key = "var", value = "value")
ma
sc
sm
x
# Custom function to mask habitats
mask_habitat <- function(x){
pred <- addLayer(etopo2022, x)
# Mask continental margin
ma <- pred %>% mask(eez) %>% as.data.frame(xy = TRUE) %>% na.omit
ma$Habitat <- cut(-ma$layer, c(0, 200, 5000), labels=c("Shelf", "Slope"))
# Mask submarine canyons
sc <- pred %>% mask(canyon) %>% mask(eez) %>% as.data.frame(xy = TRUE) %>% na.omit
sc$Habitat <- "Canyon"
# Mask seamounts
sm <- pred %>% mask(seamount) %>% mask(eez) %>% as.data.frame(xy = TRUE) %>% na.omit
sm$Habitat <- "Seamount"
# Combine and stack data frame
rbind(ma, sc, sm) %>% gather(-x, -y, -layer, -Habitat, key = "var", value = "value")
}
out <- overlay(subset(cmip6_extoe_early, 1:4), fun=max)
names(out) <- "cmip6_extoe_early"
out
mask_habitat(out)
ggplot(data=mask_habitat(out))+
geom_violin(aes(x=Region, y=layer.2))+
labs(y="Time of Emergence of Climate Change")
head(out)
out <- overlay(subset(cmip6_extoe_early, 1:4), fun=max)
names(out) <- "cmip6_extoe_early"
out
head(mask_habitat(out))
ggplot(data=mask_habitat(out))+
geom_violin(aes(x=Habitat, y=value))+
labs(y="Time of Emergence of Climate Change")
plot_fun(out)
plot_fun(out %>% mask(eez), colours = brewer.pal(10, 'RdYlBu'), q_limits = c(0, 1))
all <- overlay(subset(cmip6_extoe_early, 1:4), fun=max)
names(all) <- "cmip6_extoe_early"
plot_fun(all %>% mask(eez), colours = brewer.pal(10, 'RdYlBu'), q_limits = c(0, 1))
?theme
plot_fun(all %>% mask(eez), colours = brewer.pal(10, 'RdYlBu'), q_limits = c(0, 1)) %+replace% theme(strip.background = element_blank())
plot_fun(all %>% mask(eez), colours = brewer.pal(10, 'RdYlBu'), q_limits = c(0, 1)) %+replace% theme(strip.background = element_blank())
p1 <- plot_fun(all %>% mask(eez), colours = brewer.pal(10, 'RdYlBu'), q_limits = c(0, 1))
p1
p1 %+replace% theme(strip.background = element_blank())
?wrap_plots
head(all%>% mask(eez) %>% as.data.frame(xy = TRUE) %>% na.omit)
bathy <- etopo2022 %>% mask(eez) %>% as.data.frame(xy = TRUE) %>% na.omit
ggplot(all%>% mask(eez) %>% as.data.frame(xy = TRUE) %>% na.omit) +
geom_raster(aes(x=x, y=y, fill=cmip6_extoe_early))+
geom_polygon(data=arg, aes(x=X, y=Y, group=PID), fill="bisque2", colour="transparent")+
geom_sf(data=as(eez, "sf"), fill="transparent", colour="red")+
geom_contour(data=bathy, aes(x=x, y=y, z=layer), breaks=-200, linetype=2, colour="gray50")+
geom_contour(data=bathy, aes(x=x, y=y, z=layer), breaks=-4000, linetype=1, colour="gray50")+
scale_fill_gradientn(colours=brewer.pal(10, 'RdYlBu'))+
scale_x_continuous(expand = expansion(mult = 0))+
scale_y_continuous(expand = expansion(mult = 0))+
labs(x=NULL, y=NULL, fill=NULL)+
theme_bw() %+replace% theme(legend.position = "right", legend.key.height =  unit(1.8, 'cm'))
all <- overlay(subset(cmip6_extoe_early, 1:4), fun=max)
names(all) <- "cmip6_extoe_early"
bathy <- etopo2022 %>% mask(eez) %>% as.data.frame(xy = TRUE) %>% na.omit
p1 <- ggplot(all%>% mask(eez) %>% as.data.frame(xy = TRUE) %>% na.omit) +
geom_raster(aes(x=x, y=y, fill=cmip6_extoe_early))+
geom_polygon(data=arg, aes(x=X, y=Y, group=PID), fill="bisque2", colour="transparent")+
#geom_sf(data=as(eez, "sf"), fill="transparent", colour="red")+
geom_contour(data=bathy, aes(x=x, y=y, z=layer), breaks=-200, linetype=2, colour="gray50")+
geom_contour(data=bathy, aes(x=x, y=y, z=layer), breaks=-4000, linetype=1, colour="gray50")+
scale_fill_gradientn(colours=brewer.pal(10, 'RdYlBu'))+
scale_x_continuous(expand = expansion(mult = 0))+
scale_y_continuous(expand = expansion(mult = 0))+
labs(x=NULL, y=NULL, fill=NULL)+
theme_bw() %+replace% theme(legend.position = "right", legend.key.height =  unit(1.8, 'cm'))
# Violin plots
p2 <- ggplot(data=mask_habitat(all))+
geom_violin(aes(x=Habitat, y=value))+
labs(y="Time of Emergence of Climate Change")
p2+p1+plot_layout(widths = c(1, 2))
p2+p1
cum_imp <- function(r){
# Negative cumulative impact (exposure to climate change hazards for epc<0, o2<0, ph<0, and thetao>0)
n2050 <- addLayer(calc(subset(r, 1:3), fun=function(x){x[x>0]<-NA; return(-x)}),
calc(subset(r, 4), fun=function(x){x[x<0]<-NA; return(x)})
) %>%　overlay(fun=function(x)sum(x, na.rm=T))
# Positive cumulative impact (exposure to climate change hazards for epc>0, o2>0, ph>0, and thetao<0)
p2050 <- addLayer(calc(subset(r, 1:3), fun=function(x){x[x<0]<-NA; return(x)}),
calc(subset(r, 4), fun=function(x){x[x>0]<-NA; return(-x)})
) %>%　overlay(fun=function(x)sum(x, na.rm=T))
out <- addLayer(n2050, p2050)
names(out) <- c("Negative", "Positive")
out <- mask(out, etopo2022)
return(out)
}
plot_fun(r=cum_imp(cmip6_2041_2060_exsd) %>% mask(eez))
mask_habitat(cum_imp(cmip6_2041_2060_exsd))
cum_imp(cmip6_2041_2060_exsd) %>% mask_habitat
ggplot(data=cum_imp(cmip6_2041_2060_exsd) %>% mask_habitat)+
geom_violin(aes(x=Habitat, y=value))+
facet_wrap(~var, scales="free")+
labs(y="Cumulative Climate Change Impact")
plot_fun(cmip6_2041_2060_voccMeg %>% subset(1:4) %>% mask(eez), q_limits=c(0.01, 0.99))
cmip6_2041_2060_voccMeg %>% subset(1:4) %>% mask_habitat
ggplot(data=cmip6_2041_2060_voccMeg %>% subset(1:4) %>% mask_habitat)+
geom_violin(aes(x=Habitat, y=value))+
facet_wrap(~var, scales="free", nrow=1)+
labs(y="Climate Velocity Magnitudes")
plot_fun(r=cum_imp(cmip6_2041_2060_voccMeg) %>% mask(eez), q_limits = c(0, 0.99))
ggplot(data=cum_imp(cmip6_2041_2060_voccMeg) %>% mask_habitat)+
geom_violin(aes(x=Region, y=value))+
facet_wrap(~var, scales="free")+
labs(y="Cumulative Climate Change Impact")
cum_imp(cmip6_2041_2060_voccMeg)
cum_imp(cmip6_2041_2060_voccMeg) %>% mask_habitat
ggplot(data=cum_imp(cmip6_2041_2060_voccMeg) %>% mask_habitat)+
geom_violin(aes(x=Habitat, y=value))+
facet_wrap(~var, scales="free")+
labs(y="Cumulative Climate Change Impact")
ggplot(data=cmip6_2041_2060_exsd %>% subset(1:4) %>% mask_habitat)+
geom_violin(aes(x=Habitat, y=value))+
facet_wrap(~var, scales="free", nrow=1)+
labs(y="Climate Change Hazards")
ggplot(data=cmip6_extoe_early %>% subset(1:4) %>% mask_habitat)+
geom_violin(aes(x=Habitat, y=value))+
facet_wrap(~var, scales="free", nrow=1)+
labs(y="Time of Emergence of Climate Change")
all <- overlay(subset(cmip6_extoe_early, 1:4), fun=max)
names(all) <- "cmip6_extoe_early"
bathy <- etopo2022 %>% mask(eez) %>% as.data.frame(xy = TRUE) %>% na.omit
p1 <- ggplot(all%>% mask(eez) %>% as.data.frame(xy = TRUE) %>% na.omit) +
geom_raster(aes(x=x, y=y, fill=cmip6_extoe_early))+
geom_polygon(data=arg, aes(x=X, y=Y, group=PID), fill="bisque2", colour="transparent")+
#geom_sf(data=as(eez, "sf"), fill="transparent", colour="red")+
geom_contour(data=bathy, aes(x=x, y=y, z=layer), breaks=-200, linetype=2, colour="gray50")+
geom_contour(data=bathy, aes(x=x, y=y, z=layer), breaks=-4000, linetype=1, colour="gray50")+
scale_fill_gradientn(colours=brewer.pal(10, 'RdYlBu'))+
scale_x_continuous(expand = expansion(mult = 0))+
scale_y_continuous(expand = expansion(mult = 0))+
labs(x=NULL, y=NULL, fill=NULL)+
theme_bw() %+replace% theme(legend.position = "right", legend.key.height =  unit(1.8, 'cm'))
# Violin plots
p2 <- ggplot(data=mask_habitat(all))+
geom_violin(aes(x=Habitat, y=value))+
labs(y="Time of Emergence of Climate Change")
p2+p1
cum_imp <- function(r){
# Negative cumulative impact (exposure to climate change hazards for epc<0, o2<0, ph<0, and thetao>0)
n2050 <- addLayer(calc(subset(r, 1:3), fun=function(x){x[x>0]<-NA; return(-x)}),
calc(subset(r, 4), fun=function(x){x[x<0]<-NA; return(x)})
) %>%　overlay(fun=function(x)sum(x, na.rm=T))
# Positive cumulative impact (exposure to climate change hazards for epc>0, o2>0, ph>0, and thetao<0)
p2050 <- addLayer(calc(subset(r, 1:3), fun=function(x){x[x<0]<-NA; return(x)}),
calc(subset(r, 4), fun=function(x){x[x>0]<-NA; return(-x)})
) %>%　overlay(fun=function(x)sum(x, na.rm=T))
out <- addLayer(n2050, p2050)
names(out) <- c("Negative", "Positive")
out <- mask(out, etopo2022)
return(out)
}
plot_fun(r=cum_imp(cmip6_2041_2060_exsd) %>% mask(eez))
ggplot(data=cum_imp(cmip6_2041_2060_exsd) %>% mask_habitat)+
geom_violin(aes(x=Habitat, y=value))+
facet_wrap(~var, scales="free")+
labs(y="Cumulative Climate Change Impact")
knitr::opts_chunk$set(
collapse = TRUE,
message=FALSE,
warning=FALSE,
comment = "#>"
)
plot_fun(r=cmip6_2041_2060_exsd %>% subset(1:4) %>% mask(canyon))
knitr::opts_chunk$set(
collapse = TRUE,
message=FALSE,
warning=FALSE,
comment = "#>"
)
library(ArgentinaSSP126)
library(ggplot2)
library(dplyr)
library(patchwork)
library(tidyr)
library(RColorBrewer)
library(sf)
bathy <- etopo2022  %>% mask(eez) %>% as.data.frame(xy = TRUE) %>% na.omit
ggplot(bathy) +
geom_raster(aes(x=x, y=y, fill=-layer))+
geom_polygon(data=arg, aes(x=X, y=Y, group=PID), fill="bisque2", colour="transparent")+
#geom_sf(data=as(eez, "sf"), fill="transparent", colour="red")+
geom_contour(data=bathy, aes(x=x, y=y, z=layer), breaks=-200, linetype=2, colour="gray50")+
geom_contour(data=bathy, aes(x=x, y=y, z=layer), breaks=-4000, linetype=1, colour="gray50")+
geom_sf(data=as(canyon, "sf"), colour="blue")+
geom_sf(data=as(seamount, "sf"), size=0.5, colour="red")+
scale_fill_gradientn(colours=terrain.colors(7))+
scale_x_continuous(expand = expansion(mult = 0))+
scale_y_continuous(expand = expansion(mult = 0))+
labs(x=NULL, y=NULL, fill="Depth\n(m)")+
theme_bw() %+replace% theme(legend.position = "top", legend.key.width =  unit(1, 'cm'))
plot_fun <- function(r, colours=NULL, q_limits=c(0.001, 0.999)){
# Convert raster to data frame and then to list
cmip6_list <- as.data.frame(r, xy = TRUE) %>% na.omit %>%
gather(-x, -y, key = "var", value = "value") %>%
group_split(var)
# Depth
bathy <- mask(etopo2022, eez)%>% as.data.frame(xy = TRUE) %>% na.omit
# ggolot list
gg_list = lapply(cmip6_list, function(dat) {
# Color key limits and colours
lim1 <- quantile(dat$value, q_limits, na.rm=TRUE)
lim2 <- max(abs(quantile(dat$value, q_limits, na.rm=TRUE)))
# If the raster only have positive values, use sequential color palettes
if(min(lim1) >= 0) {
lims <- lim1; cols <- jet.colors2(7)
# If the raster contains negative values, use diverging color palettes
} else {
lims <- c(-lim2, lim2); cols <- jet.colors3(7)}
# If color pallette is specified, use the specified color palette
if(is.null(colours)) cols <- cols else cols <- colours
# Plot raster layer
ggplot(dat) +
geom_raster(aes(x=x, y=y, fill=value))+
geom_polygon(data=arg, aes(x=X, y=Y, group=PID), fill="bisque2", colour="transparent")+
#geom_sf(data=as(eez, "sf"), fill="transparent", colour="red")+
geom_contour(data=bathy, aes(x=x, y=y, z=layer), breaks=-200, linetype=2, colour="gray50")+
geom_contour(data=bathy, aes(x=x, y=y, z=layer), breaks=-4000, linetype=1, colour="gray50")+
#geom_sf(data=as(canyon, "sf"), colour="blue")+
#geom_sf(data=as(seamount, "sf"), size=0.5, colour="red")+
scale_fill_gradientn(colours=cols, limits=lims)+
scale_x_continuous(expand = expansion(mult = 0))+
scale_y_continuous(expand = expansion(mult = 0))+
labs(x=NULL, y=NULL, fill=NULL)+
facet_wrap(~ var) +
theme_bw() %+replace% theme(legend.position = "top", legend.key.width =  unit(1, 'cm'))
})
# Wrap ggplot list
wrap_plots(gg_list, nrow=1)
}
plot_fun(r=cmip6_2041_2060_exsd %>% subset(1:4) %>% mask(eez))
plot_fun(r=cmip6_2041_2060_exsd %>% subset(1:4) %>% mask(canyon))
plot_fun(r=cmip6_2041_2060_exsd %>% subset(1:4) %>% mask(seamounts))
plot_fun(r=cmip6_2041_2060_exsd %>% subset(1:4) %>% mask(seamount))
?merge
?intersect
union(seamount, coral)
coral
seamount
cmip6_2041_2060_exsd %>% subset(1:4) %>% mask(seamount)
cmip6_2041_2060_exsd %>% subset(1:4) %>% mask(coral)
merge(cmip6_2041_2060_exsd %>% subset(1:4) %>% mask(seamount), cmip6_2041_2060_exsd %>% subset(1:4) %>% mask(coral))
out <- merge(cmip6_2041_2060_exsd %>% subset(1:4) %>% mask(seamount), cmip6_2041_2060_exsd %>% subset(1:4) %>% mask(coral))
names(out) <- names(cmip6_2041_2060_exsd)
out <- merge(cmip6_2041_2060_exsd %>% subset(1:4) %>% mask(seamount), cmip6_2041_2060_exsd %>% subset(1:4) %>% mask(coral))
names(out)
names(cmip6_2041_2060_exsd)
names(out) <- names(cmip6_2041_2060_exsd)[1:4]
plot_fun(r=out)
bathy <- etopo2022  %>% mask(eez) %>% as.data.frame(xy = TRUE) %>% na.omit
ggplot(bathy) +
geom_raster(aes(x=x, y=y, fill=-layer))+
geom_polygon(data=arg, aes(x=X, y=Y, group=PID), fill="bisque2", colour="transparent")+
#geom_sf(data=as(eez, "sf"), fill="transparent", colour="red")+
geom_contour(data=bathy, aes(x=x, y=y, z=layer), breaks=-200, linetype=2, colour="gray50")+
geom_contour(data=bathy, aes(x=x, y=y, z=layer), breaks=-4000, linetype=1, colour="gray50")+
geom_sf(data=as(canyon, "sf"), colour="blue")+
geom_sf(data=as(seamount, "sf"), size=0.5, colour="red")+
scale_fill_gradientn(colours=terrain.colors(7))+
scale_x_continuous(expand = expansion(mult = 0))+
scale_y_continuous(expand = expansion(mult = 0))+
labs(x=NULL, y=NULL, fill="Depth\n(m)")+
theme_bw() %+replace% theme(legend.position = "top", legend.key.width =  unit(1, 'cm'))
bathy <- etopo2022  %>% mask(eez) %>% as.data.frame(xy = TRUE) %>% na.omit
ggplot(bathy) +
geom_raster(aes(x=x, y=y, fill=-layer))+
geom_polygon(data=arg, aes(x=X, y=Y, group=PID), fill="bisque2", colour="transparent")+
#geom_sf(data=as(eez, "sf"), fill="transparent", colour="red")+
geom_contour(data=bathy, aes(x=x, y=y, z=layer), breaks=-200, linetype=2, colour="gray50")+
geom_contour(data=bathy, aes(x=x, y=y, z=layer), breaks=-4000, linetype=1, colour="gray50")+
geom_sf(data=as(canyon, "sf"), colour="blue")+
geom_sf(data=as(seamount, "sf"), size=0.5, colour="red")+
geom_sf(data=as(coral, "sf"), size=0.5, colour="black")+
scale_fill_gradientn(colours=terrain.colors(7))+
scale_x_continuous(expand = expansion(mult = 0))+
scale_y_continuous(expand = expansion(mult = 0))+
labs(x=NULL, y=NULL, fill="Depth\n(m)")+
theme_bw() %+replace% theme(legend.position = "top", legend.key.width =  unit(1, 'cm'))
coral
?coral
plot_fun <- function(r, colours=NULL, q_limits=c(0.001, 0.999)){
# Convert raster to data frame and then to list
cmip6_list <- as.data.frame(r, xy = TRUE) %>% na.omit %>%
gather(-x, -y, key = "var", value = "value") %>%
group_split(var)
# Depth
bathy <- mask(etopo2022, eez)%>% as.data.frame(xy = TRUE) %>% na.omit
# ggolot list
gg_list = lapply(cmip6_list, function(dat) {
# Color key limits and colours
lim1 <- quantile(dat$value, q_limits, na.rm=TRUE)
lim2 <- max(abs(quantile(dat$value, q_limits, na.rm=TRUE)))
# If the raster only have positive values, use sequential color palettes
if(min(lim1) >= 0) {
lims <- lim1; cols <- jet.colors2(7)
# If the raster contains negative values, use diverging color palettes
} else {
lims <- c(-lim2, lim2); cols <- jet.colors3(7)}
# If color pallette is specified, use the specified color palette
if(is.null(colours)) cols <- cols else cols <- colours
# Plot raster layer
ggplot(dat) +
geom_raster(aes(x=x, y=y, fill=value))+
geom_polygon(data=arg, aes(x=X, y=Y, group=PID), fill="bisque2", colour="transparent")+
#geom_sf(data=as(eez, "sf"), fill="transparent", colour="red")+
geom_contour(data=bathy, aes(x=x, y=y, z=layer), breaks=-200, linetype=2, colour="gray50")+
geom_contour(data=bathy, aes(x=x, y=y, z=layer), breaks=-4000, linetype=1, colour="gray50")+
#geom_sf(data=as(canyon, "sf"), colour="blue")+
#geom_sf(data=as(seamount, "sf"), size=0.5, colour="red")+
scale_fill_gradientn(colours=cols, limits=lims)+
scale_x_continuous(expand = expansion(mult = 0))+
scale_y_continuous(expand = expansion(mult = 0))+
labs(x=NULL, y=NULL, fill=NULL)+
facet_wrap(~ var) +
theme_bw() %+replace% theme(legend.position = "top", legend.key.width =  unit(1, 'cm'))
})
# Wrap ggplot list
wrap_plots(gg_list, nrow=1)
}
plot_fun(r=cmip6_2041_2060_exsd %>% subset(1:4) %>% mask(eez))
plot_fun(r=cmip6_2041_2060_exsd %>% subset(1:4) %>% mask(canyon))
# Custom function to mask habitats
mask_habitat <- function(x){
pred <- addLayer(etopo2022, x)
# Mask continental margin
ma <- pred %>% mask(eez) %>% as.data.frame(xy = TRUE) %>% na.omit
ma$Habitat <- cut(-ma$layer, c(0, 200, 5000), labels=c("Shelf", "Slope"))
# Mask submarine canyons
sc <- pred %>% mask(canyon) %>% mask(eez) %>% as.data.frame(xy = TRUE) %>% na.omit
sc$Habitat <- "Canyon"
# Mask seamounts
sm <- pred %>% mask(seamount) %>% mask(eez) %>% as.data.frame(xy = TRUE) %>% na.omit
sm$Habitat <- "Seamount"
# Mask cold water corals
cwc <- pred %>% mask(coral) %>% mask(eez) %>% as.data.frame(xy = TRUE) %>% na.omit
cwc$Habitat <- "CWC"
# Combine and stack data frame
rbind(ma, sc, sm, cwc) %>% gather(-x, -y, -layer, -Habitat, key = "var", value = "value")
}
ggplot(data=cmip6_2041_2060_exsd %>% subset(1:4) %>% mask_habitat)+
geom_violin(aes(x=Habitat, y=value))+
facet_wrap(~var, scales="free", nrow=1)+
labs(y="Climate Change Hazards")
ggplot(data=cmip6_2041_2060_exsd %>% subset(1:4) %>% mask_habitat)+
geom_violin(aes(x=Habitat, y=value))+
facet_wrap(~var, scales="free", nrow=2)+
labs(y="Climate Change Hazards")
ggplot(data=cmip6_2041_2060_exsd %>% subset(1:4) %>% mask_habitat)+
geom_violin(aes(x=Habitat, y=value))+
facet_wrap(~var, scales="free", nrow=2)+
labs(y="Climate Change Hazards")
ggplot(data=cmip6_2041_2060_exsd %>% subset(1:4) %>% mask_habitat)+
geom_violin(aes(x=Habitat, y=value))+
facet_wrap(~var, scales="free", nrow=2)+
labs(y="Climate Change Hazards")
plot_fun(cmip6_extoe_early %>% subset(1:4) %>% mask(eez), colours = brewer.pal(10, 'RdYlBu'), q_limits = c(0, 1))
ggplot(data=cmip6_extoe_early %>% subset(1:4) %>% mask_habitat)+
geom_violin(aes(x=Habitat, y=value))+
facet_wrap(~var, scales="free")+
labs(y="Time of Emergence of Climate Change")
all <- overlay(subset(cmip6_extoe_early, 1:4), fun=max)
names(all) <- "cmip6_extoe_early"
bathy <- etopo2022 %>% mask(eez) %>% as.data.frame(xy = TRUE) %>% na.omit
p1 <- ggplot(all%>% mask(eez) %>% as.data.frame(xy = TRUE) %>% na.omit) +
geom_raster(aes(x=x, y=y, fill=cmip6_extoe_early))+
geom_polygon(data=arg, aes(x=X, y=Y, group=PID), fill="bisque2", colour="transparent")+
#geom_sf(data=as(eez, "sf"), fill="transparent", colour="red")+
geom_contour(data=bathy, aes(x=x, y=y, z=layer), breaks=-200, linetype=2, colour="gray50")+
geom_contour(data=bathy, aes(x=x, y=y, z=layer), breaks=-4000, linetype=1, colour="gray50")+
scale_fill_gradientn(colours=brewer.pal(10, 'RdYlBu'))+
scale_x_continuous(expand = expansion(mult = 0))+
scale_y_continuous(expand = expansion(mult = 0))+
labs(x=NULL, y=NULL, fill=NULL)+
theme_bw() %+replace% theme(legend.position = "right", legend.key.height =  unit(1.8, 'cm'))
# Violin plots
p2 <- ggplot(data=mask_habitat(all))+
geom_violin(aes(x=Habitat, y=value))+
labs(y="Time of Emergence of Climate Change")
p2+p1
p2+p1
p2+p1
p2+p1
cum_imp <- function(r){
# Negative cumulative impact (exposure to climate change hazards for epc<0, o2<0, ph<0, and thetao>0)
n2050 <- addLayer(calc(subset(r, 1:3), fun=function(x){x[x>0]<-NA; return(-x)}),
calc(subset(r, 4), fun=function(x){x[x<0]<-NA; return(x)})
) %>%　overlay(fun=function(x)sum(x, na.rm=T))
# Positive cumulative impact (exposure to climate change hazards for epc>0, o2>0, ph>0, and thetao<0)
p2050 <- addLayer(calc(subset(r, 1:3), fun=function(x){x[x<0]<-NA; return(x)}),
calc(subset(r, 4), fun=function(x){x[x>0]<-NA; return(-x)})
) %>%　overlay(fun=function(x)sum(x, na.rm=T))
out <- addLayer(n2050, p2050)
names(out) <- c("Negative", "Positive")
out <- mask(out, etopo2022)
return(out)
}
plot_fun(r=cum_imp(cmip6_2041_2060_exsd) %>% mask(eez))
ggplot(data=cum_imp(cmip6_2041_2060_exsd) %>% mask_habitat)+
geom_violin(aes(x=Habitat, y=value))+
facet_wrap(~var, scales="free")+
labs(y="Cumulative Climate Change Impact")
plot_fun(cmip6_2041_2060_voccMeg %>% subset(1:4) %>% mask(eez), q_limits=c(0.01, 0.99))
ggplot(data=cmip6_2041_2060_voccMeg %>% subset(1:4) %>% mask_habitat)+
geom_violin(aes(x=Habitat, y=value))+
facet_wrap(~var, scales="free")+
labs(y="Climate Velocity Magnitudes")
plot_fun(r=cum_imp(cmip6_2041_2060_voccMeg) %>% mask(eez), q_limits = c(0, 0.99))
ggplot(data=cum_imp(cmip6_2041_2060_voccMeg) %>% mask_habitat)+
geom_violin(aes(x=Habitat, y=value))+
facet_wrap(~var, scales="free")+
labs(y="Cumulative Climate Change Impact")
